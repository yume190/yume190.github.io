<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="前陣子花了一段時間 survey 一些 CI 的東西，從最一開始知道說有 Travis CI 以及 Drone.io。
但是這兩種屬於網頁服務，所以在語言的選擇上有些限制，以及對 Private Repo 的價格都不便宜。
於是將目光轉向一些可以自己架設的 CI Server，且 Server 如果是自己架設的話，可以建立一個比較接近開發時的測試環境。如：

Jenkins
Strider
Drone

首先嘗試的 Jenkins 老爹，但是有點被那眾多的 plugin 以及設定嚇到(加上老大似乎不喜歡)。
第二個嘗試的是 Drone，但是兩次都因為設定沒設完，首頁只會把你導引到如何設定的說明頁。
最後是 Strider，第一眼的觀感良好，實際在玩的時候也是一堆坑 XD。">
    

    <!--Author-->
    
        <meta name="author" content="Yume">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Drone CI"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Yume 練功地"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Drone CI - Yume 練功地</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2015/02/05/CI-2015-02-05-Drone-CI/">
                Drone CI
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2015-02-05</span>
            
            <a href="#disqus_thread" class="comments">Kommentare</a>
            
                <span class="category">
                    <a href="/categories/CI/">CI</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p>前陣子花了一段時間 survey 一些 CI 的東西，從最一開始知道說有 Travis CI 以及 Drone.io。</p>
<p>但是這兩種屬於網頁服務，所以在語言的選擇上有些限制，以及對 Private Repo 的價格都不便宜。</p>
<p>於是將目光轉向一些可以自己架設的 CI Server，且 Server 如果是自己架設的話，可以建立一個比較接近開發時的測試環境。如：</p>
<ul>
<li>Jenkins</li>
<li>Strider</li>
<li>Drone</li>
</ul>
<p>首先嘗試的 Jenkins 老爹，但是有點被那眾多的 plugin 以及設定嚇到(加上老大似乎不喜歡)。</p>
<p>第二個嘗試的是 Drone，但是兩次都因為設定沒設完，首頁只會把你導引到如何設定的<code>說明頁</code>。</p>
<p>最後是 Strider，第一眼的觀感良好，實際在玩的時候也是一堆坑 XD。</p>
<a id="more"></a>
<hr>
<h2 id="Install-amp-Run"><a href="#Install-amp-Run" class="headerlink" title="Install &amp; Run"></a>Install &amp; Run</h2><p>講到安裝的話，可以先參考這兩篇:</p>
<ul>
<li><a href="http://jipiboily.com/2014/from-zero-to-fully-working-ci-server-in-less-than-10-minutes-with-drone-docker/" target="_blank" rel="external">From zero to fully working CI server in less than 10 minutes with Drone &amp; Docker</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-perform-continuous-integration-testing-with-drone-io-on-coreos-and-docker" target="_blank" rel="external">How To Perform Continuous Integration Testing with Drone.io on CoreOS and Docker</a></li>
</ul>
<p>由於在玩 <code>Strider</code> 的時候被 Docker 操了一下，所以大概知道有些大大已經 Dockerhub 放上了他們的心血結晶。</p>
<p>我們的任務就把它找出來，心存感謝的使用(如果他有好好寫說明以及 <code>Dockerfile</code> 的話)。</p>
<figure class="highlight docker"><figcaption><span>Dokcerfile</span><a href="https://registry.hub.docker.com/u/mattgruter/drone/dockerfile/" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> mattgruter/doubledocker</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> Matthias Grüter &lt;matthias@grueter.name&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span> <span class="bash">apt-get -y install htop</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">apt-get -y install wget</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">wget http://downloads.drone.io/master/drone.deb</span><br><span class="line"></span><span class="keyword">RUN</span> <span class="bash">dpkg -i drone.deb</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span> <span class="bash">/var/lib/drone</span><br><span class="line"></span></span><br><span class="line"><span class="keyword">ENV</span> DRONE_SERVER_PORT :<span class="number">80</span></span><br><span class="line"><span class="keyword">ENV</span> DRONE_DATABASE_DATASOURCE /var/lib/drone/drone.sqlite</span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span> <span class="bash">/etc/init.d/docker start &amp;&amp; /usr/<span class="built_in">local</span>/bin/droned</span></span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile-弱弱解說"><a href="#Dockerfile-弱弱解說" class="headerlink" title="Dockerfile 弱弱解說"></a>Dockerfile 弱弱解說</h3><h4 id="Port"><a href="#Port" class="headerlink" title="Port"></a>Port</h4><p><code>ENV DRONE_SERVER_PORT :80</code> 設定環境變數，讓 Drone 在 port 80 開啟。</p>
<p><code>EXPOSE 80</code> 這個 container 會把 port 80 導出來。</p>
<p>因此 <code>docker run</code> 可以用 <font color="red"><code>-p 8080:80</code></font> 將 container 的 port 80 導到 外面的port 8080。</p>
<h4 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h4><p>…</p>
<h4 id="sqlite"><a href="#sqlite" class="headerlink" title="sqlite"></a>sqlite</h4><p><code>ENV DRONE_DATABASE_DATASOURCE /var/lib/drone/drone.sqlite</code> container 會把資料庫放在 /var/lib/drone/drone.sqlite</p>
<p>我們可以在 host 準備一個資料給 container 放。</p>
<p>例如我們打算提供 ~/drone.sqlite 給 container，<code>touch ~/drone.sqlite</code>。</p>
<p>因此 <code>docker run</code> 可以用 <font color="red"><code>-v ~/drone.sqlite:/var/lib/drone/drone.sqlite</code></font>，把 host 的 ~/drone.sqlite 給 container 當 /var/lib/drone/drone.sqlite 用。</p>
<figure class="highlight plain"><figcaption><span>mattgruter/drone</span><a href="https://registry.hub.docker.com/u/mattgruter/drone/" target="_blank" rel="external">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker pull mattgruter/drone</span><br><span class="line"></span><br><span class="line">docker run -e DRONE_GITHUB_CLIENT=&quot;...&quot; \</span><br><span class="line">           -e DRONE_GITHUB_SECRET=&quot;...&quot; \</span><br><span class="line">           -p 8080:80 \</span><br><span class="line">           -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">           -v ~/drone.sqlite:/var/lib/drone/drone.sqlite \</span><br><span class="line">           --privileged \</span><br><span class="line">           mattgruter/drone</span><br><span class="line"># Drone run at http://localhost:8080</span><br></pre></td></tr></table></figure>
<p>Drone 的相關環境變數設定可以參考<a href="https://github.com/drone/drone#setup" target="_blank" rel="external">Drone Setup</a></p>
<h2 id="Link-Github"><a href="#Link-Github" class="headerlink" title="Link Github"></a>Link Github</h2><p><code>DRONE_GITHUB_CLIENT</code> &amp; <code>DRONE_GITHUB_SECRET</code> 這兩個參數必須到 Github 領取</p>
<p>設定方式可以參考<a href="http://readme.drone.io/setup/config/github/" target="_blank" rel="external">Setting Github</a></p>
<p>Github 的設定頁 -&gt; Applications -&gt; Register new application</p>
<p>Example:</p>
<ul>
<li><strong><code>Application name</code></strong> Drone</li>
<li><strong><code>Homepage URL</code></strong> <a href="http://x.y.z" target="_blank" rel="external">http://x.y.z</a></li>
<li><strong><code>Authorization callback URL</code></strong> <a href="http://x.y.z:12345/api/auth/github.com" target="_blank" rel="external">http://x.y.z:12345/api/auth/github.com</a></li>
</ul>
<h2 id="Link-Bitbucket"><a href="#Link-Bitbucket" class="headerlink" title="Link Bitbucket"></a>Link Bitbucket</h2><p>可以在<a href="https://github.com/drone/drone#setup" target="_blank" rel="external">Drone Setup</a>看到 <code>DRONE_BITBUCKET_CLIENT</code> &amp; <code>DRONE_BITBUCKET_SECRET</code> 這兩個環境變數</p>
<p>設定方式一樣可以參考<a href="http://readme.drone.io/setup/config/bitbucket/" target="_blank" rel="external">Setting Bitbucket</a></p>
<p>Bitbucket 首頁 -&gt; Manage Account -&gt; Oauth -&gt; Add consumer</p>
<p>Example:</p>
<ul>
<li><strong><code>Name</code></strong> Drone</li>
<li><strong><code>URL</code></strong> <a href="http://x.y.z:12345/api/auth/bitbucket.org" target="_blank" rel="external">http://x.y.z:12345/api/auth/bitbucket.org</a></li>
</ul>
<font color="white"><br>github 上提到的設定<br><br>[registration]<br>open=true<br><br>以及<br><br>環境變數 export DRONE_REGISTRATION_OPEN=false<br><br>似乎在alpha版是個假像<br><br><br>真正有作用的反而在 Drone Readme<br>[bitbucket]<br>open = false<br>[github]<br>open = true<br><br>以及環境變數<br>DRONE_BITBUCKET_OPEN<br>DRONE_GITHUB_OPEN<br><br>至於這個變數幹嘛用的，遇到就知道了(誤)<br></font>

<h2 id="使用心得"><a href="#使用心得" class="headerlink" title="使用心得"></a>使用心得</h2><p>使用 Drone 的話，必須編寫 <code>.drone.yml</code>，如果之前有玩過 Travis 話，會感覺一些些熟悉。</p>
<p><code>.travis.yml</code> 會在首行指定語言。</p>
<figure class="highlight yml"><figcaption><span>.travis.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> android</span><br><span class="line"><span class="attr">jdk:</span> oraclejdk7</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><code>.drone.yml</code> 在首行指定 <code>Docker Image</code>!!!! 一整個只有驚喜啊 :)</p>
<figure class="highlight yml"><figcaption><span>.drone.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> python2<span class="number">.6</span></span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>
<p><code>.drone.yml</code> 的語法可以參考</p>
<ul>
<li><a href="https://github.com/drone/drone/blob/v0.2.1/README.md#builds" target="_blank" rel="external">Drone Build</a></li>
<li><a href="https://github.com/drone/drone/issues/6" target="_blank" rel="external">Matrix Builds / Sub-Builds / Parallel Builds #6</a></li>
</ul>
<p>Other Ref:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/24946414/building-docker-images-with-drone-io" target="_blank" rel="external">Building Docker Images with Drone.io</a></li>
<li><a href="https://registry.hub.docker.com/u/dockercore/drone/" target="_blank" rel="external">dockercore / drone</a></li>
</ul>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/CI/">#CI</a> <a href="/tags/Drone/">#Drone</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    工作時的筆記
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2016/12/05/OpenWRT-2016-12-05-uhttp-lua/">uhttp lua</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/12/01/Linux-2016-12-01-let-s-Make/">let&#39;s Make</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/11/24/OpenWRT-2016-11-24-OpenWRT-uci/">OpenWRT uci</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2016/11/24/OpenWRT-2016-11-24-OpenWRT-ubus/">OpenWRT ubus</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/IOS/UI/">UI</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/Work/">Work</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/Design-Pattern/Dependency-Injection/">Dependency Injection</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/Google-API/">Google API</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/yume190">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/yume190">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:yume190@gmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>